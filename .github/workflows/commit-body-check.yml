name: Commit Body Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-commit-body:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit body
        id: get_commit
        run: |
          COMMIT_BODY=$(git log --format=%b -n 1 ${{ github.event.pull_request.head.sha }})
          echo "commit_body<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "üìù Commit body:"
          echo "$COMMIT_BODY"

      - name: Check - body line length max 72 characters
        run: |
          BODY="${{ steps.get_commit.outputs.commit_body }}"
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É —Ç–µ–ª–∞ –∫–æ–º–º–∏—Ç–∞
          LINE_NUMBER=0
          while IFS= read -r line; do
            LINE_NUMBER=$((LINE_NUMBER + 1))
            if [[ ${#line} -gt 72 ]]; then
              echo "‚ùå Line $LINE_NUMBER in body is too long: ${#line} characters (max 72)"
              echo "   Content: '$line'"
              exit 1
            fi
          done <<< "$BODY"
          echo "‚úÖ All lines in commit body are 72 characters or less"

      - name: Check - body in English only
        run: |
          BODY="${{ steps.get_commit.outputs.commit_body }}"
          # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –µ—Å–ª–∏ —Ç–µ–ª–æ –ø—É—Å—Ç–æ–µ
          if [[ -z "$BODY" ]]; then
            echo "‚ÑπÔ∏è  Commit body is empty, skipping English check"
            exit 0
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ-–ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
          while IFS= read -r line; do
            if [[ -n "$line" ]]; then
              if [[ "$line" =~ [^a-zA-Z0-9[:space:][:punct:]] ]]; then
                echo "‚ùå Body contains non-English characters"
                echo "   Problematic line: '$line'"
                exit 1
              fi
            fi
          done <<< "$BODY"
          echo "‚úÖ Only English characters used in body"

      - name: Check - body separated by empty line from header
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞
          FULL_COMMIT=$(git log --format=%B -n 1 ${{ github.event.pull_request.head.sha }})
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ (–∑–∞–≥–æ–ª–æ–≤–∫–∞) –∏–¥–µ—Ç –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
          SECOND_LINE=$(echo "$FULL_COMMIT" | sed -n '2p')
          if [[ -n "$SECOND_LINE" ]]; then
            echo "‚ùå Body must be separated from header by an empty line"
            echo "   Second line should be empty, but got: '$SECOND_LINE'"
            exit 1
          fi
          echo "‚úÖ Body is properly separated from header by empty line"

      - name: All checks passed
        run: |
          echo "‚úÖ Commit body follows all rules!"
          echo "   ‚úì Max 72 characters per line"
          echo "   ‚úì English language only"
          echo "   ‚úì Separated by empty line from header"