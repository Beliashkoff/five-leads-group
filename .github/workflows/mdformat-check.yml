name: Markdown Format Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.md'

jobs:
  mdformat-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed markdown files
        id: changed-files
        run: |
          echo "–ò—â–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ .md —Ñ–∞–π–ª—ã..."
          CHANGED_MD_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E '\.md$' || true)
          
          if [ -z "$CHANGED_MD_FILES" ]; then
            echo "‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö .md —Ñ–∞–π–ª–æ–≤ –≤ —ç—Ç–æ–º PR"
            echo "changed_md_files=none" >> $GITHUB_OUTPUT
          else
            echo "üìÑ –ù–∞–π–¥–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ .md —Ñ–∞–π–ª—ã:"
            echo "$CHANGED_MD_FILES"
            echo "changed_md_files=$CHANGED_MD_FILES" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.changed-files.outputs.changed_md_files != 'none'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install mdformat
        if: steps.changed-files.outputs.changed_md_files != 'none'
        run: |
          echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º mdformat..."
          pip install mdformat
          echo "‚úÖ mdformat —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"

      - name: Check markdown formatting
        if: steps.changed-files.outputs.changed_md_files != 'none'
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö .md —Ñ–∞–π–ª–æ–≤..."
          IFS=$'\n' read -d '' -r -a files <<< "${{ steps.changed-files.outputs.changed_md_files }}" || true
          
          if mdformat --check "${files[@]}"; then
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
          else
            echo "‚ùå –û—à–∏–±–∫–∞: –ù–∞–π–¥–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ .md —Ñ–∞–π–ª—ã!"
            exit 1
          fi

      - name: Success - no markdown changes
        if: steps.changed-files.outputs.changed_md_files == 'none'
        run: |
          echo "------------------------------------------------"
          echo "‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö .md —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"
          echo "------------------------------------------------"
