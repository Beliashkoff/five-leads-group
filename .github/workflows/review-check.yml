name: Check Approval Comments

on:
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      required_approvals:
        description: 'Number of required approvals'
        required: false
        default: '1'

env:
  REQUIRED_APPROVALS: ${{ github.event.inputs.required_approvals || '1' }}

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    if: github.event.pull_request != null || github.event.issue.pull_request != null
    
    steps:
      - name: Count Approvals
        uses: actions/github-script@v7
        env:
          REQUIRED: ${{ env.REQUIRED_APPROVALS }}
        with:
          script: |
            const REQUIRED = parseInt(process.env.REQUIRED);
            
            // Ð§Ñ‚Ð¾ ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ð·Ð° Ð°Ð¿Ñ€ÑƒÐ²
            const isApproval = (text) => {
              const t = text.trim().toLowerCase();
              return t === 'ðŸ‘';
            };
            
            const prNumber = context.payload.pull_request?.number || 
                           context.payload.issue?.number;
            
            const pr = context.payload.pull_request || 
                      (await github.rest.pulls.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: prNumber
                      })).data;
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const approvers = new Set();
            
            for (const comment of comments.data) {
              if (isApproval(comment.body) && 
                  comment.user.login !== pr.user.login) {
                approvers.add(comment.user.login);
              }
            }
            
            const count = approvers.size;
            const passed = count >= REQUIRED;
            
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: pr.head.sha,
              state: passed ? 'success' : 'pending',
              context: 'approvals',
              description: `${count}/${REQUIRED} approvals: ${Array.from(approvers).join(', ') || 'none'}`,
            });
            
            if (!passed) {
              core.setFailed(`Need ${REQUIRED - count} more`);
            } else {
              console.log('âœ… All checks passed! PR has enough approvals.');
              console.log(`âœ… Got ${count} approvals from: ${Array.from(approvers).join(', ')}`);
              core.info(`âœ… Success! PR approved by ${count} reviewers: ${Array.from(approvers).join(', ')}`);
            }
